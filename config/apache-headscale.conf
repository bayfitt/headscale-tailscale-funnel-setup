# Headscale Apache Configuration with iOS Authentication Fix
# Apache reverse proxy configuration for Headscale with Tailscale Funnel

# HTTP server (for Tailscale Funnel proxy)
# Tailscale Funnel handles HTTPS termination and forwards to this HTTP virtual host
<VirtualHost *:80>
    ServerName your-headscale-server.ts.net  # Replace with your Tailscale hostname
    
    # Enable mod_rewrite for iOS authentication fix
    RewriteEngine On
    
    # iOS Authentication Fix
    # Automatically inject v=88 parameter for iOS Tailscale clients
    # This fixes the "capability version must be set" error on iOS devices
    RewriteCond %{HTTP_USER_AGENT} tailscale.*ios [NC]
    RewriteCond %{REQUEST_URI} ^/key$
    RewriteCond %{QUERY_STRING} !v= [NC]
    RewriteRule ^/key$ http://127.0.0.1:8080/key?%{QUERY_STRING}&v=88 [QSA,L,P]
    
    # Standard reverse proxy for all requests with Tailscale protocol support
    # The upgrade=any parameter is critical for WebSocket/ts2021 protocol support
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:8080/ upgrade=any
    ProxyPassReverse / http://127.0.0.1:8080/
    
    # Headers for proper HTTPS proxying through Tailscale Funnel
    # These headers ensure Headscale knows the requests came via HTTPS
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader set X-Real-IP %{REMOTE_ADDR}s
    
    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    
    # Logging for debugging and monitoring
    ErrorLog ${APACHE_LOG_DIR}/headscale_error.log
    CustomLog ${APACHE_LOG_DIR}/headscale_access.log combined
    
    # Enable detailed rewrite logging (disable in production for performance)
    # LogLevel rewrite:trace2
</VirtualHost>

# HTTPS Virtual Host (Optional - for direct access without Funnel)
# This section is included for completeness but not used when Tailscale Funnel is active
# Uncomment and configure if you need direct HTTPS access
#
# <VirtualHost *:443>
#     ServerName your-headscale-server.ts.net
#     
#     # SSL Configuration (provide your own certificates)
#     SSLEngine on
#     SSLCertificateFile /path/to/your/cert.pem
#     SSLCertificateKeyFile /path/to/your/key.pem
#     
#     # Modern SSL settings
#     SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
#     SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305
#     SSLHonorCipherOrder off
#     SSLSessionTickets off
#     
#     # Same configuration as HTTP virtual host
#     RewriteEngine On
#     RewriteCond %{HTTP_USER_AGENT} tailscale.*ios [NC]
#     RewriteCond %{REQUEST_URI} ^/key$
#     RewriteCond %{QUERY_STRING} !v= [NC]
#     RewriteRule ^/key$ http://127.0.0.1:8080/key?%{QUERY_STRING}&v=88 [QSA,L,P]
#     
#     ProxyPreserveHost On
#     ProxyPass / http://127.0.0.1:8080/ upgrade=any
#     ProxyPassReverse / http://127.0.0.1:8080/
#     
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Port "443"
#     RequestHeader set X-Real-IP %{REMOTE_ADDR}s
#     
#     Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
#     Header always set X-Content-Type-Options nosniff
#     Header always set X-Frame-Options DENY
#     
#     ErrorLog ${APACHE_LOG_DIR}/headscale_error.log
#     CustomLog ${APACHE_LOG_DIR}/headscale_access.log combined
# </VirtualHost>

# Configuration Notes:
#
# 1. iOS Fix Explanation:
#    - iOS Tailscale clients require a capability version parameter (v=88)
#    - The rewrite rule detects iOS user agents and automatically adds this parameter
#    - Without this fix, iOS clients get "400 Bad Request" errors
#
# 2. WebSocket Support:
#    - The upgrade=any parameter enables Tailscale's custom WebSocket protocol (ts2021)
#    - This is essential for proper client-server coordination
#    - Standard WebSocket upgrade headers are not used by Tailscale
#
# 3. Tailscale Funnel Integration:
#    - Funnel handles SSL termination and forwards to the HTTP virtual host (port 80)
#    - No HTTP-to-HTTPS redirect is needed (Funnel handles this)
#    - X-Forwarded-* headers ensure proper HTTPS detection
#
# 4. Security Considerations:
#    - HSTS header enforces HTTPS for all future requests
#    - X-Frame-Options prevents clickjacking attacks
#    - X-Content-Type-Options prevents MIME sniffing
#
# 5. Required Apache Modules:
#    - mod_proxy: Basic reverse proxy functionality
#    - mod_proxy_http: HTTP proxy support
#    - mod_proxy_wstunnel: WebSocket tunneling (for upgrade=any)
#    - mod_rewrite: URL rewriting for iOS fix
#    - mod_headers: HTTP header manipulation